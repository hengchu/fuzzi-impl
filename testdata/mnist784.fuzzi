db:[1.0]     { [float](785) };
db1:    { [float](786) };

partitions:     { int };


w:      [float](785);
dws:    { [float](785) };

w_total: { [float](785)};

lamb: float;
rate: float;

i:    int;
j:    int;

zero785: [float](785);
zero786: [float](786);

trow:  [float](785);
trow1: [float](786);
trow2: [float](786);

wout: [float](785);
prob: float;
dt: float;
sc: float;

tw : [float](785);
tf_out : float;
dws_j: { float };
dws_bias : { float };
dws_one : { float };
dws_two : { float };

tsum : float;
bias_sum : float;
one_sum : float;
two_sum : float;
j_sum: float;
temp: float;
size: float;

lamb = 0.1;
rate = 0.1;

repeat 20 {

bmap(db, db1, trow, i, trow1, {
  j = 0;
  trow1[0] = 1.0;
  repeat 785 {
    trow1[j+1] = trow[j];
    j = j + 1;
  }
});

bmap(db1, dws, trow2, i, wout, {
  j = 0;
  repeat 785 {
    wout[j] = trow2[j];
    j = j + 1;
  };

  dt = clip(dot(wout, w), 10000.0);
  temp = exp((0.0-1.0) * (trow2[785]) * dt);
  prob = 1.0 / (1.0 + temp);
  sc = (1.0 - prob) * (trow2[785]);
  wout = scale(sc, wout);

  dt = 0.0;
  temp = 0.0;
  prob = 0.0;
  sc = 0.0;
  j = 0;
});

j = 0;

size $= lap(1.0, float(length(db)));

repeat 785 {
  bmap(dws, dws_j, tw, i, tf_out, { tf_out = tw[j]; });

  j_sum = 0.0;
  tsum = 0.0;
  bsum(dws_j, j_sum, tsum, i, 1.0);


  j_sum $= lap(1.0, j_sum);

  w[j] = w[j] + (j_sum / size - 2.0*lamb*(w[j])) * rate ;
  j = j + 1;
};

i = 0;
tf_out = 0.0;
tsum = 0.0;
wout = zero785;
tw = zero785;
trow = zero785;
trow1 = zero786;
trow2 = zero786;
dt = 0.0;
temp = 0.0;
prob = 0.0;
sc = 0.0;
j = 0;

}
